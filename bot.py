import logging
import random
import json
import os
import asyncio
from datetime import datetime, date, timedelta
from filelock import FileLock
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
import pytz

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler("bot.log", encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

DATA_FILE = "user_data.json"
LOCK_FILE = DATA_FILE + ".lock"
MOSCOW_TZ = pytz.timezone('Europe/Moscow')

# ======================= –ú–ï–°–°–ï–î–ñ–ò =======================

MORNING_MESSAGES = [
    "–ü—Ä–∏–≤–µ—Ç. –î–∞–≤–∞–π —Å–µ–≥–æ–¥–Ω—è –Ω–µ –±—É–¥–µ–º, —Ö–æ—Ä–æ—à–æ?",
    "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ. –ù–µ —Å–µ–≥–æ–¥–Ω—è.",
    "–ü—Ä–∏–≤–µ—Ç. –î–µ—Ä–∂–∏–º—Å—è —Å–µ–≥–æ–¥–Ω—è?",
    "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ. –°–µ–≥–æ–¥–Ω—è –º–Ω–æ–≥–æ –¥–µ–ª, –Ω–∞–≤–µ—Ä–Ω–æ–µ –Ω–µ—Ç.",
    "–ü—Ä–∏–≤–µ—Ç. –°–µ–≥–æ–¥–Ω—è –æ–±–æ–π–¥—ë–º—Å—è –±–µ–∑ —ç—Ç–æ–≥–æ.",
    "–£—Ç—Ä–æ. –î–∞–≤–∞–π —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ–ø—É—Å—Ç–∏–º.",
    "–ü—Ä–∏–≤–µ—Ç. –°–µ–≥–æ–¥–Ω—è –ø–æ–∂–∞–ª—É–π —á—Ç–æ –Ω–µ —Å—Ç–æ–∏—Ç.",
    "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ. –ù–∞–ø–∏—à—É –µ—â—ë —Å–µ–≥–æ–¥–Ω—è.",
    "–ü—Ä–∏–≤–µ—Ç. –°–µ–≥–æ–¥–Ω—è —Ç–æ—á–Ω–æ –Ω–µ –Ω–∞–¥–æ.",
    "–î–æ–±—Ä–æ–µ! –î–∞–≤–∞–π —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ —ç—Ç–æ–≥–æ."
]

EVENING_MESSAGES = [
    "–ù–µ —Å–µ–≥–æ–¥–Ω—è. –î–µ—Ä–∂–∏—Å—å.",
    "–Ø —Ç—É—Ç. –î–∞–≤–∞–π –Ω–µ —Å–µ–≥–æ–¥–Ω—è.",
    "–ü—Ä–∏–≤–µ—Ç. –°–µ–≥–æ–¥–Ω—è –¥–µ—Ä–∂–∏–º—Å—è, –ø–æ–º–Ω–∏—à—å?",
    "–î–µ—Ä–∂–∏—Å—å. –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç.",
    "–ï—â—ë —á—É—Ç—å-—á—É—Ç—å. –ù–µ —Å–µ–≥–æ–¥–Ω—è.",
    "–Ø —Å —Ç–æ–±–æ–π. –°–µ–≥–æ–¥–Ω—è —Ç–æ—á–Ω–æ –Ω–µ—Ç.",
    "–ü—Ä–∏–≤–µ—Ç. –î–∞–≤–∞–π –æ–±–æ–π–¥—ë–º—Å—è.",
    "–ú—ã –∂–µ —Ä–µ—à–∏–ª–∏ ‚Äî –Ω–µ —Å–µ–≥–æ–¥–Ω—è.",
    "–î–µ—Ä–∂–∏—Å—å —Ç–∞–º. –°–µ–≥–æ–¥–Ω—è –º–∏–º–æ.",
    "–ü—Ä–∏–≤–µ—Ç. –°–µ–≥–æ–¥–Ω—è –ø—Ä–æ–ø—É—Å—Ç–∏–º."
]

NIGHT_MESSAGES = [
    "–¢—ã –º–æ–ª–æ–¥–µ—Ü. –î–æ –∑–∞–≤—Ç—Ä–∞.",
    "–ö—Ä–∞—Å–∞–≤—á–∏–∫. –°–ø–æ–∫–æ–π–Ω–æ–π.",
    "–î–µ—Ä–∂–∞–ª—Å—è —Å–µ–≥–æ–¥–Ω—è. –£–≤–∞–∂–∞—é.",
    "–°–µ–≥–æ–¥–Ω—è —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å. –î–æ –∑–∞–≤—Ç—Ä–∞.",
    "–ú–æ–ª–æ–¥–µ—Ü, –¥–µ—Ä–∂–∏—à—å—Å—è.",
    "–ï—â—ë –æ–¥–∏–Ω –¥–µ–Ω—å –ø–æ–∑–∞–¥–∏.",
    "–¢—ã —Å–∏–ª—å–Ω—ã–π. –î–æ –∑–∞–≤—Ç—Ä–∞.",
    "–°–µ–≥–æ–¥–Ω—è –ø–æ–ª—É—á–∏–ª–æ—Å—å. –û—Ç–¥—ã—Ö–∞–π.",
    "–°–ø—Ä–∞–≤–∏–ª—Å—è. –£–≤–∞–∂–µ–Ω–∏–µ.",
    "–î–µ—Ä–∂–∞–ª—Å—è –≤–µ—Å—å –¥–µ–Ω—å. –ö—Ä–∞—Å–∞–≤–∞."
]

TU_TUT_FIRST = [
    "–¢—É—Ç.", "–ü—Ä–∏–≤–µ—Ç.", "–ê –∫—É–¥–∞ —è –¥–µ–Ω—É—Å—å?", "–ó–¥–µ—Å—å.", "–¢—É—Ç, –∫–∞–∫ –≤—Å–µ–≥–¥–∞.",
    "–î–∞, –¥–∞.", "–ö–∞–∫ –¥–µ–ª–∞?", "–ê–≥–∞.", "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π.", "–¢—É—Ç, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π."
]

TU_TUT_SECOND = [
    "–î–µ—Ä–∂–∏–º—Å—è.", "–Ø —Å —Ç–æ–±–æ–π.", "–í—Å—ë –ø–æ –ø–ª–∞–Ω—É.", "–ù–µ —Ö–æ—á—É —Å–µ–≥–æ–¥–Ω—è.", "–°–µ–≥–æ–¥–Ω—è –Ω–µ –±—É–¥—É.",
    "–Ø —Ä—è–¥–æ–º.", "–î–µ—Ä–∂–∏—Å—å.", "–í—Å—ë –±—É–¥–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.", "–Ø –≤ –¥–µ–ª–µ.", "–ü–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º."
]

HOLD_RESPONSES = ["–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ‚úä", "–ú–æ–ª–æ–¥–µ—Ü. ‚úä", "–ü–æ–Ω—è–ª. ‚úä", "–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å. ‚úä"]

MILESTONES = {
    3: "‚ú® –¢—Ä–∏ –¥–Ω—è —É–∂–µ. –°–∞–º–æ–µ —Ç—è–∂—ë–ª–æ–µ –ø–æ–∑–∞–¥–∏.",
    7: "‚ú® –ù–µ–¥–µ–ª—è. –†–µ—Ü–µ–ø—Ç–æ—Ä—ã –Ω–∞—á–∏–Ω–∞—é—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è.",
    14: "‚ú® –î–≤–µ –Ω–µ–¥–µ–ª–∏! –°–æ–Ω –Ω–∞–ª–∞–∂–∏–≤–∞–µ—Ç—Å—è, –≥–æ–ª–æ–≤–∞ —è—Å–Ω–µ–µ.",
    21: "‚ú® –¢—Ä–∏ –Ω–µ–¥–µ–ª–∏. –¢—ã —É–∂–µ –ø–æ—á—Ç–∏ –Ω–µ –¥—É–º–∞–µ—à—å –æ–± —ç—Ç–æ–º.",
    30: "‚ú® –ú–µ—Å—è—Ü –±–µ–∑ —ç—Ç–æ–≥–æ. –ú–æ–∑–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ-–Ω–æ–≤–æ–º—É.",
    60: "‚ú® –î–≤–∞ –º–µ—Å—è—Ü–∞ ‚Äî —Ç—ã –¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫.",
    90: "‚ú® –¢—Ä–∏ –º–µ—Å—è—Ü–∞. –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ. –¢—ã –º–æ–ª–æ–¥–µ—Ü.",
    180: "‚ú® –ü–æ–ª–≥–æ–¥–∞. –õ–µ–≥–µ–Ω–¥–∞.",
    365: "‚ú® –ì–û–î –ß–ò–°–¢–´–ú. –¢—ã —Å–¥–µ–ª–∞–ª —ç—Ç–æ ‚ù§Ô∏è"
}

HELP_TECHNIQUES = [
    "üßä –õ—ë–¥ –Ω–∞ –∑–∞–ø—è—Å—Ç—å—è 30-60 —Å–µ–∫. –•–æ–ª–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –±–ª—É–∂–¥–∞—é—â–∏–π –Ω–µ—Ä–≤ ‚Äî —Ç—è–≥–∞ –ø–∞–¥–∞–µ—Ç –∑–∞ –º–∏–Ω—É—Ç—É.",
    "ü´Å –î—ã—Ö–∞–Ω–∏–µ 4-7-8: –≤–¥–æ—Ö –Ω–∞ 4 ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7 ‚Üí –≤—ã–¥–æ—Ö –Ω–∞ 8. 4 —Ä–∞–∑–∞. –°–Ω–∏–∂–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª.",
    "‚è± –¢–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç: ¬´–ü—Ä–æ—Å—Ç–æ –ø–æ–¥–æ–∂–¥–∏¬ª. –¢—è–≥–∞ –∫–∞–∫ –≤–æ–ª–Ω–∞ ‚Äî –ø—Ä–æ–π–¥—ë—Ç —Å–∞–º–∞ –∑–∞ 3-7 –º–∏–Ω—É—Ç.",
    "üö™ –í—Å—Ç–∞–Ω—å –∏ –≤—ã–π–¥–∏ –≤ –¥—Ä—É–≥—É—é –∫–æ–º–Ω–∞—Ç—É. –°–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω—É—é —Å–≤—è–∑—å.",
    "üçã –ö—É—Å–æ–∫ –ª–∏–º–æ–Ω–∞ –∏–ª–∏ –∏–º–±–∏—Ä—è –≤ —Ä–æ—Ç. –†–µ–∑–∫–∏–π –≤–∫—É—Å –ø–µ—Ä–µ–±–∏–≤–∞–µ—Ç –¥–æ—Ñ–∞–º–∏–Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª.",
    "‚úä –°–æ–∂–º–∏ –∫—É–ª–∞–∫–∏ 10 —Å–µ–∫ ‚Üí –æ—Ç–ø—É—Å—Ç–∏. 5 —Ä–∞–∑. –§–∏–∑–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç.",
    "üíß –£–º–æ–π –ª–∏—Ü–æ –ª–µ–¥—è–Ω–æ–π –≤–æ–¥–æ–π 30 —Å–µ–∫. –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ä–µ—Ñ–ª–µ–∫—Å –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —É—Å–ø–æ–∫–æ–µ–Ω–∏–µ.",
    "üìù –ù–∞–ø–∏—à–∏ 3 –ø—Ä–∏—á–∏–Ω—ã, –ø–æ—á–µ–º—É —Å–µ–π—á–∞—Å –Ω–µ –Ω–∞–¥–æ. –ü–æ–º–æ–≥–∏ –º–æ–∑–≥—É –≤—Å–ø–æ–º–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É.",
    "ü´Å 10 –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–æ–≤. –ö–∏—Å–ª–æ—Ä–æ–¥ —Å–Ω–∏–∂–∞–µ—Ç –∞–¥—Ä–µ–Ω–∞–ª–∏–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å.",
    "üí™ –ü–ª–∞–Ω–∫–∞ 45-60 —Å–µ–∫—É–Ω–¥. –ü–æ–∫–∞ –º—ã—à—Ü—ã –≥–æ—Ä—è—Ç ‚Äî –≥–æ–ª–æ–≤–∞ –Ω–µ –¥—É–º–∞–µ—Ç –æ —Ç—è–≥–µ.",
    "üö∂ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ 7-10 –º–∏–Ω—É—Ç. –î–≤–∏–∂–µ–Ω–∏–µ –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç BDNF ‚Äî –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –∞–Ω—Ç–∏–¥–µ–ø—Ä–µ—Å—Å–∞–Ω—Ç.",
    "üëÄ 5-4-3-2-1: –Ω–∞–∑–æ–≤–∏ 5 –≤–µ—â–µ–π (–≤–∏–∂—É), 4 (—Ç—Ä–æ–≥–∞—é), 3 (—Å–ª—ã—à—É), 2 (–∑–∞–ø–∞—Ö), 1 (–≤–∫—É—Å).",
    "üöø –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –¥—É—à: 30 —Å–µ–∫ —Ö–æ–ª–æ–¥–Ω–æ–π ‚Üí 1 –º–∏–Ω —Ç—ë–ø–ª–æ–π. –ü–æ–≤—Ç–æ—Ä–∏ 2 —Ä–∞–∑–∞.",
    "ü•ú –°—ä–µ—à—å –≥–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤ –∏–ª–∏ —Å—ã—Ä–∞. –ë–µ–ª–æ–∫ –∏ –∂–∏—Ä—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—é—Ç —Å–∞—Ö–∞—Ä –≤ –∫—Ä–æ–≤–∏.",
    "üéæ –°–æ–∂–º–∏ —Ç–µ–Ω–Ω–∏—Å–Ω—ã–π –º—è—á–∏–∫ –¥–æ –±–æ–ª–∏. 10 —Ä–∞–∑. –§–∏–∑–∏—á–µ—Å–∫–∏–π –≤—ã–±—Ä–æ—Å –∞–¥—Ä–µ–Ω–∞–ª–∏–Ω–∞ —á–µ—Ä–µ–∑ —Ä—É–∫–∏.",
    "üí™ –ü–æ–∑–∞ —Å–∏–ª—ã 2 –º–∏–Ω—É—Ç—ã: –Ω–æ–≥–∏ —à–∏—Ä–æ–∫–æ, —Ä—É–∫–∏ –≤ –±–æ–∫–∏, –≥—Ä—É–¥—å –≤–ø–µ—Ä—ë–¥.",
    "ü§î HALT: –≥–æ–ª–æ–¥–µ–Ω? –∑–ª–æ–π? –æ–¥–∏–Ω–æ–∫? —É—Å—Ç–∞–ª? –ò—Å–ø—Ä–∞–≤—å —Ö–æ—Ç—å –æ–¥–Ω–æ.",
    "üåä Urge Surfing: –ø—Ä–µ–¥—Å—Ç–∞–≤—å —Ç—è–≥—É –∫–∞–∫ –≤–æ–ª–Ω—É. –ù–µ –±–æ—Ä–∏—Å—å ‚Äî –Ω–∞–±–ª—é–¥–∞–π —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã.",
    "üí¨ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–º—É: ¬´–¢—è–∂–∫–æ, –±—Ä–∞—Ç¬ª. –°—Ç—ã–¥–Ω–æ? –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
    "üí™ 20 –æ—Ç–∂–∏–º–∞–Ω–∏–π –¥–æ –æ—Ç–∫–∞–∑–∞. –ü–æ–∫–∞ —Ç–µ–ª–æ –≤ —à–æ–∫–µ ‚Äî –º–æ–∑–≥ –∑–∞–±—ã–≤–∞–µ—Ç –ø—Ä–æ –¥–æ—Ñ–∞–º–∏–Ω–æ–≤—ã–π –≥–æ–ª–æ–¥."
]

RECOVERY_STAGES = [
    """üìÖ –î–ù–ò 1-3: –û–°–¢–†–ê–Ø –§–ê–ó–ê

–ü–∏–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤. –†–µ—Ü–µ–ø—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∏–≤—ã—á–Ω—ã–π –¥–æ—Ñ–∞–º–∏–Ω.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –ø–æ—Ç–ª–∏–≤–æ—Å—Ç—å
‚Ä¢ –¢—Ä–µ–≤–æ–≥–∞ 8-10/10
‚Ä¢ –†–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
‚Ä¢ –ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞
‚Ä¢ –°–∏–ª—å–Ω–∞—è —Ç—è–≥–∞ –∫–∞–∂–¥—ã–µ 1-2 —á–∞—Å–∞

–≠—Ç–æ —Å–∞–º–æ–µ —Ç—è–∂—ë–ª–æ–µ –≤—Ä–µ–º—è. –î–µ—Ä–∂–∏—Å—å.""",
    
    """üìÖ –î–ù–ò 4-7: –ü–û–î–û–°–¢–†–ê–Ø –§–ê–ó–ê

–°–∏–º–ø—Ç–æ–º—ã —Å–Ω–∏–∂–∞—é—Ç—Å—è –Ω–∞ 40%. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∫–∞—á–µ—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚Ä¢ –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Å–∏–º–ø—Ç–æ–º—ã —Å–ª–∞–±–µ—é—Ç
‚Ä¢ –ü–æ—è–≤–ª—è—é—Ç—Å—è –æ–∫–Ω–∞ —è—Å–Ω–æ—Å—Ç–∏
‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è –≤—Å—ë –µ—â—ë –Ω–∏–∑–∫–∞—è
‚Ä¢ –¢—è–≥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ä–µ–∂–µ
‚Ä¢ –≠–º–æ—Ü–∏–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã

–ú–æ–∑–≥ —É—á–∏—Ç—Å—è –∂–∏—Ç—å –ø–æ-–Ω–æ–≤–æ–º—É.""",
    
    """üìÖ –î–ù–ò 8-14: –ê–î–ê–ü–¢–ê–¶–ò–Ø

–†–µ—Ü–µ–ø—Ç–æ—Ä—ã –æ–∂–∏–≤–∞—é—Ç. CB1-—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã –Ω–∞—á–∏–Ω–∞—é—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚Ä¢ –°–æ–Ω –Ω–∞–ª–∞–∂–∏–≤–∞–µ—Ç—Å—è
‚Ä¢ –ê–ø–ø–µ—Ç–∏—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
‚Ä¢ –¢—è–≥–∞ —Å–ª–∞–±–µ–µ—Ç
‚Ä¢ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞–¥–æ—Å—Ç—å
‚Ä¢ –ì–æ–ª–æ–≤–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–µ–µ

–¢—ã —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—à—å —Ä–∞–∑–Ω–∏—Ü—É.""",
    
    """üìÖ –î–ù–ò 15-28: –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï

–ú–æ–∑–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∏—â–µ. –î–æ—Ñ–∞–º–∏–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –Ω–æ—Ä–º—É.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è
‚Ä¢ –≠–º–æ—Ü–∏–∏ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
‚Ä¢ –†–∞–¥–æ—Å—Ç—å –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–µ–π
‚Ä¢ –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ +25%
‚Ä¢ –¢—è–≥–∞ —Ä–µ–¥–∫–∞—è –∏ —Å–ª–∞–±–∞—è

–¢—ã –¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫.""",
    
    """üìÖ –î–ù–ò 29-90: –°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø

–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π. –ù–æ–≤–∞—è –Ω–æ—Ä–º–∞ –∂–∏–∑–Ω–∏.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚Ä¢ CB1-—Ä–µ—Ü–µ–ø—Ç–æ—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
‚Ä¢ –î–æ—Ñ–∞–º–∏–Ω –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
‚Ä¢ –ñ–∏–∑–Ω—å –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚Ä¢ –¢—è–≥–∞ –ø–æ—á—Ç–∏ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
‚Ä¢ –¢—ã —Å–≤–æ–±–æ–¥–µ–Ω

–≠—Ç–æ —Ç–≤–æ—è –Ω–æ–≤–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å."""
]

# –¢—Ä–∏–≥–≥–µ—Ä—ã, –∏—Å–∫–∞–∂–µ–Ω–∏—è, —Ñ–∞–∫—Ç—ã ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
# –°–æ–∫—Ä–∞—â–∞—é –∑–¥–µ—Å—å –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –≤ –∫–æ–¥–µ –≤—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–∞–∫ —É —Ç–µ–±—è

# ======================= –î–ê–ù–ù–´–ï =======================

_user_data_cache = None
_data_lock = asyncio.Lock()

def get_main_keyboard():
    buttons = [
        [InlineKeyboardButton("‚úä –î–µ—Ä–∂—É—Å—å", callback_data="hold"),
         InlineKeyboardButton("üòî –¢—è–∂–µ–ª–æ", callback_data="heavy")],
        [InlineKeyboardButton("üëã –¢—ã —Ç—É—Ç?", callback_data="are_you_here"),
         InlineKeyboardButton("üìä –î–Ω–∏", callback_data="days")],
        [InlineKeyboardButton("‚ù§Ô∏è –°–ø–∞—Å–∏–±–æ", callback_data="thank_you"),
         InlineKeyboardButton("‚è∏ –ü–æ–º–æ–ª—á–∏", callback_data="stop")]
    ]
    return InlineKeyboardMarkup(buttons)

def get_start_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("‚ñ∂ –ù–∞—á–∞—Ç—å", callback_data="start")]])

def get_heavy_keyboard():
    buttons = [
        [InlineKeyboardButton("üî• –°–¥–µ–ª–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", callback_data="exercise"),
         InlineKeyboardButton("üß† –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="info")],
        [InlineKeyboardButton("üíî –°—Ä—ã–≤", callback_data="breakdown"),
         InlineKeyboardButton("‚Ü© –ù–∞–∑–∞–¥", callback_data="back")]
    ]
    return InlineKeyboardMarkup(buttons)

def get_info_keyboard():
    buttons = [
        [InlineKeyboardButton("üìÖ –°—Ç–∞–¥–∏–∏", callback_data="stages"),
         InlineKeyboardButton("‚ö†Ô∏è –¢—Ä–∏–≥–≥–µ—Ä—ã", callback_data="triggers")],
        [InlineKeyboardButton("ü§Ø –ò—Å–∫–∞–∂–µ–Ω–∏—è", callback_data="distortions"),
         InlineKeyboardButton("üî¨ –§–∞–∫—Ç—ã", callback_data="facts")],
        [InlineKeyboardButton("‚Ü© –ù–∞–∑–∞–¥", callback_data="back")]
    ]
    return InlineKeyboardMarkup(buttons)

# ======================= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –î–ê–ù–ù–´–• =======================

def load_data():
    global _user_data_cache
    if _user_data_cache is not None:
        return _user_data_cache
    with FileLock(LOCK_FILE):
        if not os.path.exists(DATA_FILE):
            _user_data_cache = {}
            return _user_data_cache
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                _user_data_cache = json.load(f)
                return _user_data_cache
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
            _user_data_cache = {}
            return {}

async def save_data():
    global _user_data_cache
    async with _data_lock:
        with FileLock(LOCK_FILE):
            try:
                with open(DATA_FILE, "w", encoding="utf-8") as f:
                    json.dump(_user_data_cache, f, ensure_ascii=False, indent=2)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")

def get_user(user_id):
    data = load_data()
    uid = str(user_id)
    if uid not in data:
        data[uid] = {
            "start_date": None,
            "active": False,
            "best_streak": 0,
            "hold_count_today": 0,
            "last_hold_date": None,
            "last_hold_time": None,
            "last_stage_index": 0,
            "used_tips": [], "used_triggers": [], "used_distortions": [], "used_facts": []
        }
        asyncio.create_task(save_data())
    return data[uid]

async def save_user(user_id, updates=None):
    data = load_data()
    uid = str(user_id)
    if updates:
        if uid not in data:
            data[uid] = {}
        data[uid].update(updates)
    await save_data()

def get_days_since_start(user_id):
    user = get_user(user_id)
    if not user["start_date"]:
        return 0
    try:
        start = date.fromisoformat(user["start_date"])
        current = datetime.now(MOSCOW_TZ).date()
        return max((current - start).days, 0)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –¥–Ω–µ–π –¥–ª—è {user_id}: {e}")
        return 0

# ======================= –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö =======================

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    chat_id = query.message.chat_id
    user = get_user(chat_id)

    if data == "start":
        await start_user(chat_id, context)
    elif data == "stop":
        await stop_user(chat_id, context)
    elif data == "hold":
        await handle_hold(query, context)
    elif data == "heavy":
        await query.edit_message_text("–ß—Ç–æ –Ω—É–∂–Ω–æ?", reply_markup=get_heavy_keyboard())
    elif data == "exercise":
        tip = random.choice(HELP_TECHNIQUES)
        await query.edit_message_text(tip, reply_markup=get_heavy_keyboard())
    elif data == "info":
        await query.edit_message_text("–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª:", reply_markup=get_info_keyboard())
    elif data == "days":
        days = get_days_since_start(chat_id)
        await query.edit_message_text(f"–¢—ã –¥–µ—Ä–∂–∏—à—å—Å—è {days} –¥–Ω–µ–π", reply_markup=get_main_keyboard())
    elif data == "are_you_here":
        await handle_are_you_here(query)
    elif data == "thank_you":
        await query.edit_message_text("–°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å ‚ù§Ô∏è", reply_markup=get_main_keyboard())
    # TODO: –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É stages, triggers, distortions, facts –∏ breakdown —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö —Å—Ç–∞–¥–∏–π

# ======================= –ó–ê–î–ï–†–ñ–ö–ê –î–õ–Ø "–¢–´ –¢–£–¢?" =======================

async def handle_are_you_here(query):
    first = random.choice(TU_TUT_FIRST)
    second = random.choice(TU_TUT_SECOND)
    await asyncio.sleep(random.randint(2, 6))
    await query.edit_message_text(first, reply_markup=get_main_keyboard())
    await asyncio.sleep(random.randint(2, 5))
    await query.edit_message_text(f"{first}\n{second}", reply_markup=get_main_keyboard())

# ======================= –ó–ê–ü–£–°–ö =======================

def main():
    application = Application.builder().token(TOKEN).build()
    application.add_handler(CallbackQueryHandler(handle_callback))
    application.run_polling(allowed_updates=Update.ALL_TYPES)
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")

if __name__ == "__main__":
    main()
